name: Roll core update

on:
  push:
    branches:
      - main
    paths:
      - 'revisions.json'
      - '.github/workflows/roll_core_update.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'revisions.json'
      - '.github/workflows/roll_core_update.yaml'

jobs:
  rolling_core_update:
    name: Rolling core update
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: set up python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      - name: Storing ssh key file
        run: echo "$SSH_KEY" > ssh_key && chmod 700 ./ssh_key
        env:
          SSH_KEY: ${{ secrets.CORE_SSH_KEY }}
      - name: Installing YC util
        run: curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i /opt/yandex-cloud -n
      - name: Authorizing YC util
        run: source /opt/yandex-cloud/path.bash.inc && echo $SERVICE_KEY>service_key.json && yc config profile create sa-profile && yc config set service-account-key service_key.json && yc config set cloud-id $YC_CLOUD_ID && yc config set folder-id $YC_FOLDER_ID
        env:
          SERVICE_KEY: ${{ secrets.REGISTRY_KEY }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
      - name: List instances
        run: source /opt/yandex-cloud/path.bash.inc && yc compute instance list
      - name: Launching rolling script
        run: source /opt/yandex-cloud/path.bash.inc && python3 tools/roll_update.py core ./revisions.json ./ssh_key
